<!-- Breadcrumb Section -->
<section class="bg-white border-b border-gray-200 px-6 py-4">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2">
                    <li>
                        <span class="text-sm font-medium text-gray-900" th:text="${currentUser}">User Name</span>
                    </li>
                    <li>
                        <span class="text-gray-400">/</span>
                    </li>
                    <li>
                        <span class="text-sm text-gray-500">Profile from <span th:text="${userFirstName}"></span> <span th:text="${userLastName}"></span></span>
                    </li>
                </ol>
            </nav>
        </div>
        <div class="flex items-center space-x-3">
            <button class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" id="save-profile">
                <svg class="-ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" />
                </svg>
                Save Changes
            </button>
        </div>
    </div>
</section>

<!-- Hero Section -->
<section class="bg-gradient-to-r from-primary-600 to-primary-700 text-white">
    <div class="px-6 py-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">Profile</h1>
                <p class="mt-2 text-primary-100">Manage user profile information</p>
            </div>
            <div class="hidden lg:block">
                <!-- Hero icon -->
            </div>
        </div>
    </div>
</section>

<!-- Main Content Section -->
<section class="px-6 py-6 space-y-6">
    <form id="profile-form" class="space-y-6">
        <!-- Basic Information -->
        <div class="bg-white rounded-lg shadow border border-gray-200">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <h2 class="text-lg font-medium text-gray-900">Basic Information</h2>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Username</label>
                        <div class="mt-1">
                            <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 bg-gray-50" 
                                   name="username" 
                                   type="text" 
                                   th:value="${username}" 
                                   disabled readonly>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <div class="mt-1">
                            <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500" 
                                   name="email" 
                                   type="email" 
                                   th:value="${userEmail}">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">First Name</label>
                        <div class="mt-1">
                            <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500" 
                                   name="firstName" 
                                   type="text" 
                                   th:value="${userFirstName}">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Last Name</label>
                        <div class="mt-1">
                            <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500" 
                                   name="lastName" 
                                   type="text" 
                                   th:value="${userLastName}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security -->
        <div class="bg-white rounded-lg shadow border border-gray-200">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                    </svg>
                    <h2 class="text-lg font-medium text-gray-900">Security</h2>
                </div>
            </div>
            
            <div class="p-6">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">New Password</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500" 
                                       name="password" 
                                       type="password">
                            </div>
                            <p class="mt-2 text-sm text-gray-500">Leave blank to keep current password</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Last Login</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 bg-gray-50" 
                                       name="lastLogin" 
                                       type="text" 
                                       th:value="${lastLogin}" 
                                       disabled readonly>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Failed Login Attempts</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 bg-gray-50" 
                                       name="failedLoginAttempts" 
                                       type="number"
                                       th:value="${failedLoginAttempts}" 
                                       disabled readonly>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Lockout Until</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 bg-gray-50" 
                                       name="lockoutUntil" 
                                       type="datetime-local" 
                                       th:value="${lockoutUntil}"
                                       disabled readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Details -->
        <div class="bg-white rounded-lg shadow border border-gray-200">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5zm6-10.125a1.875 1.875 0 11-3.75 0 1.875 1.875 0 013.75 0z" />
                    </svg>
                    <h2 class="text-lg font-medium text-gray-900">Personal Details</h2>
                </div>
            </div>
            
            <div class="p-6">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Birthdate</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500" 
                                       name="birthdate" 
                                       type="date" 
                                       th:value="${birthdate}">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Gender</label>
                            <div class="mt-1">
                                <select class="block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                                        name="gender">
                                    <option value="">Select gender</option>
                                    <option value="male" th:selected="${gender == 'male'}">Male</option>
                                    <option value="female" th:selected="${gender == 'female'}">Female</option>
                                    <option value="other" th:selected="${gender == 'other'}">Other</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500" 
                                       name="phoneNumber" 
                                       type="tel" 
                                       th:value="${phoneNumber}">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Location</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500" 
                                       name="location" 
                                       type="text" 
                                       th:value="${location}">
                            </div>
                        </div>

                        <div class="lg:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Website</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500" 
                                       name="website" 
                                       type="url" 
                                       th:value="${website}">
                            </div>
                        </div>

                        <div class="lg:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Bio</label>
                            <div class="mt-1">
                                <textarea class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500" 
                                          name="bio" 
                                          rows="3" 
                                          th:text="${bio}"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Picture and Metadata -->
        <div class="bg-white rounded-lg shadow border border-gray-200">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                    </svg>
                    <h2 class="text-lg font-medium text-gray-900">Profile Picture & Metadata</h2>
                </div>
            </div>
            
            <div class="p-6">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Profile Picture URL</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500" 
                                       name="profilePicture" 
                                       type="url" 
                                       th:value="${userProfilePicture}">
                            </div>
                        </div>

                        <div class="flex items-center justify-center">
                            <div class="flex-shrink-0">
                                <img class="h-20 w-20 rounded-full border border-gray-300" 
                                     th:src="${userProfilePicture != null and !userProfilePicture.isEmpty() ? userProfilePicture : 'https://openmoji.org/data/color/svg/1F9D9-200D-2642-FE0F.svg'}" 
                                     alt="Profile Picture"
                                     id="profile-preview">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Created At</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 bg-gray-50" 
                                       type="text" 
                                       th:value="${createdAt}" 
                                       disabled readonly>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Updated At</label>
                            <div class="mt-1">
                                <input class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 bg-gray-50" 
                                       type="text" 
                                       th:value="${updatedAt}" 
                                       disabled readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Message display area -->
    <div id="profile-message" class="hidden">
        <!-- Success/error messages will be displayed here -->
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const saveButton = document.getElementById('save-profile');
    const profileForm = document.getElementById('profile-form');
    const profileMessage = document.getElementById('profile-message');
    const profilePreview = document.getElementById('profile-preview');
    const profilePictureInput = document.querySelector('input[name="profilePicture"]');

    // Update profile picture preview when URL changes
    if (profilePictureInput && profilePreview) {
        profilePictureInput.addEventListener('input', function() {
            const url = this.value;
            if (url) {
                profilePreview.src = url;
            } else {
                profilePreview.src = 'https://openmoji.org/data/color/svg/1F9D9-200D-2642-FE0F.svg';
            }
        });
    }

    if (saveButton && profileForm) {
        saveButton.addEventListener('click', function () {
            const formData = new FormData(profileForm);
            const data = {
                email: formData.get('email'),
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                password: formData.get('password'),
                phoneNumber: formData.get('phoneNumber'),
                birthdate: formData.get('birthdate'),
                gender: formData.get('gender'),
                location: formData.get('location'),
                website: formData.get('website'),
                bio: formData.get('bio'),
                profilePicture: formData.get('profilePicture')
            };

            // Remove empty password field (only if empty string or null, not if it has whitespace)
            if (!data.password || data.password.trim() === '') {
                delete data.password;
            }

            // Clean up empty strings to null for optional fields
            Object.keys(data).forEach(key => {
                if (data[key] === '' || (typeof data[key] === 'string' && data[key].trim() === '')) {
                    data[key] = null;
                }
            });

            console.log('Sending profile update data:', data);

            fetch(window.location.pathname, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('auth_token') ? 'Bearer ' + localStorage.getItem('auth_token') : ''
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (response.ok) {
                    return response.text().then(text => {
                        console.log('Response text:', text);
                        // Success
                        profileMessage.innerHTML = '<div class="bg-green-50 border border-green-200 rounded-md p-4"><div class="text-sm text-green-800">Profile updated successfully!</div></div>';
                        profileMessage.classList.remove('hidden');
                        setTimeout(() => {
                            profileMessage.classList.add('hidden');
                        }, 3000);
                    });
                } else {
                    return response.text().then(text => {
                        console.log('Error response text:', text);
                        // Error
                        profileMessage.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-md p-4"><div class="text-sm text-red-800">' + (text || 'Error updating profile') + '</div></div>';
                        profileMessage.classList.remove('hidden');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                profileMessage.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-md p-4"><div class="text-sm text-red-800">Network error. Please try again.</div></div>';
                profileMessage.classList.remove('hidden');
            });
        });
    }
});
</script>